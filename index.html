<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Emoji Browser</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            margin: 20px;
            margin-bottom: 10px;
        }
        .tabs {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 1001;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs-left {
            display: flex;
            gap: 0;
        }
        .tabs-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #333;
            background-color: #f5f5f5;
        }
        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #controls {
            background-color: #f5f5f5;
            padding: 15px 20px 20px 20px;
        }
        #search {
            width: 100%;
            max-width: 800px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        #stats {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .selection-btn {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .selection-btn:hover {
            background-color: #45a049;
        }
        .selection-btn.danger {
            background-color: #f44336;
        }
        .selection-btn.danger:hover {
            background-color: #da190b;
        }
        #selected-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            background-color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            margin: 20px;
            color: #999;
            font-size: 18px;
        }
        #pagination {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .page-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .page-btn:hover:not(:disabled) {
            background-color: #45a049;
        }
        .page-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .page-info {
            font-weight: bold;
        }
        #page-jump {
            padding: 6px;
            width: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            background-color: white;
            padding: 20px;
            margin: 0 20px 40px 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .emoji-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            cursor: pointer;
        }
        .emoji-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .emoji-card.selected {
            background-color: #c8e6c9;
            border: 2px solid #4CAF50;
        }
        .emoji-image {
            max-width: 100px;
            max-height: 100px;
            margin-bottom: 10px;
        }
        .emoji-name {
            font-family: monospace;
            font-size: 12px;
            text-align: center;
            word-break: break-all;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="tabs">
        <div class="tabs-left">
            <button class="tab active" onclick="switchTab('browse')">Browse</button>
            <button class="tab" onclick="switchTab('selected')">Selected (<span id="tab-selected-count">0</span>)</button>
        </div>
        <div class="tabs-right">
            <span><strong>Selected:</strong> <span id="header-selected-count">0</span></span>
            <button class="selection-btn" onclick="exportSelected()">Export List</button>
            <button class="selection-btn danger" onclick="clearSelected()">Clear All</button>
        </div>
    </div>

    <div id="browse-tab" class="tab-content active">
        <div id="controls">
            <input type="text" id="search" placeholder="Search emoji names..." autofocus>

            <div id="stats">
                <span id="stats-text">Loading...</span>
            </div>

            <div id="pagination">
                <button class="page-btn" id="first-btn" onclick="goToPage(1)">First</button>
                <button class="page-btn" id="prev-btn" onclick="goToPage(currentPage - 1)">Previous</button>
                <span class="page-info">
                    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                </span>
                <button class="page-btn" id="next-btn" onclick="goToPage(currentPage + 1)">Next</button>
                <button class="page-btn" id="last-btn" onclick="goToPage(totalPages)">Last</button>
                <span>Jump to:</span>
                <input type="number" id="page-jump" min="1" value="1">
                <button class="page-btn" onclick="goToPage(parseInt(document.getElementById('page-jump').value))">Go</button>
            </div>
        </div>

        <div id="emoji-grid"></div>
    </div>

    <div id="selected-tab" class="tab-content">
        <div id="selected-grid-container">
            <div id="selected-empty" class="empty-state">
                No emojis selected yet. Click emojis in the Browse tab to add them here.
            </div>
            <div id="selected-grid"></div>
        </div>
    </div>

    <script>
        // Emoji filenames embedded directly
        const allEmojiFiles = [
EMOJI_DATA_PLACEHOLDER
        ];

        let filteredEmojis = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let totalPages = 1;
        let selectedEmojis = new Set();

        // Load selected emojis from localStorage and sync with server
        async function loadSelectedEmojis() {
            const saved = localStorage.getItem('selectedEmojis');
            if (saved) {
                selectedEmojis = new Set(JSON.parse(saved));
            }

            // Sync with server's selected folder
            try {
                const response = await fetch('/api/selected');
                const data = await response.json();
                const serverFiles = new Set(data.files);

                // Copy any files in localStorage but not on server
                for (const filename of selectedEmojis) {
                    if (!serverFiles.has(filename)) {
                        await fetch('/api/select', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: filename })
                        });
                    }
                }

                // Add any files on server but not in localStorage
                for (const filename of serverFiles) {
                    if (!selectedEmojis.has(filename)) {
                        selectedEmojis.add(filename);
                    }
                }

                saveSelectedEmojis();
            } catch (err) {
                console.error('Sync error:', err);
            }

            updateSelectedCount();
        }

        // Save selected emojis to localStorage
        function saveSelectedEmojis() {
            localStorage.setItem('selectedEmojis', JSON.stringify([...selectedEmojis]));
            updateSelectedCount();
        }

        // Update selected count display
        function updateSelectedCount() {
            document.getElementById('tab-selected-count').textContent = selectedEmojis.size;
            document.getElementById('header-selected-count').textContent = selectedEmojis.size;
            renderSelectedGrid();
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'browse') {
                document.getElementById('browse-tab').classList.add('active');
            } else if (tabName === 'selected') {
                document.getElementById('selected-tab').classList.add('active');
                renderSelectedGrid();
            }
        }

        // Render selected emojis grid
        function renderSelectedGrid() {
            const grid = document.getElementById('selected-grid');
            const emptyState = document.getElementById('selected-empty');

            if (selectedEmojis.size === 0) {
                emptyState.style.display = 'block';
                grid.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = '';

            const selectedArray = [...selectedEmojis].sort();

            selectedArray.forEach(filename => {
                // Extract just the basename for display
                const basename = filename.split('/').pop();
                const name = basename.replace(/\.[^.]*$/, '');

                const card = document.createElement('div');
                card.className = 'emoji-card selected';

                // Add click handler to deselect
                card.addEventListener('click', () => toggleSelection(filename));

                const img = document.createElement('img');
                img.src = `emojis/${filename}`;
                img.alt = name;
                img.className = 'emoji-image';
                img.loading = 'lazy';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'emoji-name';
                nameDiv.textContent = name;
                // Add tooltip with full path
                nameDiv.title = filename;

                card.appendChild(img);
                card.appendChild(nameDiv);
                grid.appendChild(card);
            });
        }

        // Toggle emoji selection
        function toggleSelection(filename) {
            if (selectedEmojis.has(filename)) {
                selectedEmojis.delete(filename);
                // Call API to delete file from selected folder
                fetch('/api/deselect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                }).catch(err => console.error('Deselect error:', err));
            } else {
                selectedEmojis.add(filename);
                // Call API to copy file to selected folder
                fetch('/api/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                }).catch(err => console.error('Select error:', err));
            }
            saveSelectedEmojis();
            renderPage();
        }

        // Export selected emojis list
        function exportSelected() {
            if (selectedEmojis.size === 0) {
                alert('No emojis selected yet!');
                return;
            }
            const list = [...selectedEmojis].sort().join('\n');
            const blob = new Blob([list], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected-emojis.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear all selections
        function clearSelected() {
            if (selectedEmojis.size === 0) {
                alert('No emojis selected yet!');
                return;
            }
            if (confirm(`Clear all ${selectedEmojis.size} selected emojis?`)) {
                // Delete all files from selected folder
                const filesToDelete = [...selectedEmojis];
                filesToDelete.forEach(filename => {
                    fetch('/api/deselect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: filename })
                    }).catch(err => console.error('Deselect error:', err));
                });
                selectedEmojis.clear();
                saveSelectedEmojis();
                renderPage();
            }
        }

        // Initialize
        (async function init() {
            await loadSelectedEmojis();
            filteredEmojis = allEmojiFiles;
            totalPages = Math.ceil(filteredEmojis.length / itemsPerPage);

            // Restore saved page from localStorage
            const savedPage = localStorage.getItem('emojiCurrentPage');
            if (savedPage) {
                const pageNum = parseInt(savedPage);
                if (pageNum >= 1 && pageNum <= totalPages) {
                    currentPage = pageNum;
                }
            }

            updateStats();
            renderPage();
        })();

        // Search functionality
        let searchTimeout;
        document.getElementById('search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();

                if (searchTerm === '') {
                    filteredEmojis = allEmojiFiles;
                } else {
                    filteredEmojis = allEmojiFiles.filter(filename => {
                        const name = filename.replace(/\.[^.]*$/, '').toLowerCase();
                        return name.includes(searchTerm);
                    });
                }

                currentPage = 1;
                totalPages = Math.ceil(filteredEmojis.length / itemsPerPage);
                localStorage.setItem('emojiCurrentPage', currentPage);
                updateStats();
                renderPage();
            }, 300);
        });

        function updateStats() {
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, filteredEmojis.length);
            const percentThrough = ((end / allEmojiFiles.length) * 100).toFixed(1);
            const statsText = `Total: ${allEmojiFiles.length} emojis | Showing: ${filteredEmojis.length} | Displaying: ${start}-${end} (${percentThrough}%)`;
            document.getElementById('stats-text').textContent = statsText;
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('page-jump').max = totalPages;
        }

        function renderPage() {
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, filteredEmojis.length);
            const pageEmojis = filteredEmojis.slice(start, end);

            pageEmojis.forEach(filename => {
                // Extract just the basename for display
                const basename = filename.split('/').pop();
                const name = basename.replace(/\.[^.]*$/, '');

                const card = document.createElement('div');
                card.className = 'emoji-card';

                // Check if this emoji is selected
                if (selectedEmojis.has(filename)) {
                    card.classList.add('selected');
                }

                // Add click handler
                card.addEventListener('click', () => toggleSelection(filename));

                const img = document.createElement('img');
                img.src = `emojis/${filename}`;
                img.alt = name;
                img.className = 'emoji-image';
                img.loading = 'lazy';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'emoji-name';
                nameDiv.textContent = name;
                // Add tooltip with full path
                nameDiv.title = filename;

                card.appendChild(img);
                card.appendChild(nameDiv);
                grid.appendChild(card);
            });

            // Update pagination buttons
            document.getElementById('first-btn').disabled = currentPage === 1;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
            document.getElementById('last-btn').disabled = currentPage === totalPages;
            document.getElementById('page-jump').value = currentPage;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            localStorage.setItem('emojiCurrentPage', currentPage);
            updateStats();
            renderPage();
        }
    </script>
</body>
</html>
